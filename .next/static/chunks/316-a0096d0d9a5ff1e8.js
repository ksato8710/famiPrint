"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[316],{3236:function(e,t,o){o.d(t,{Z:function(){return CategoryEditor}});var a=o(7437),r=o(2265),n=o(2899),l=o(8053),i=o(243);function ConfirmModal(e){let{isOpen:t,onClose:o,message:r,onConfirm:n,onCancel:l}=e;return(0,a.jsxs)(i.Z,{isOpen:t,onClose:o,title:"確認",children:[(0,a.jsx)("p",{children:r}),(0,a.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"10px",marginTop:"20px"},children:[(0,a.jsx)("button",{onClick:()=>{l(),o()},className:"category-editor-close-button",children:"キャンセル"}),(0,a.jsx)("button",{onClick:()=>{n(),o()},className:"primary-button",children:"OK"})]})]})}let EditIcon=()=>(0,a.jsx)("svg",{className:"icon",fill:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})}),DeleteIcon=()=>(0,a.jsx)("svg",{className:"icon",fill:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"})}),SaveIcon=()=>(0,a.jsx)("svg",{className:"icon",fill:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"})}),CancelIcon=()=>(0,a.jsx)("svg",{className:"icon",fill:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{d:"M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"})});function CategoryEditor(e){let{onClose:t,existingCategories:o,onCategoryUpdated:i,isForSinglePrint:c=!1,currentPrintCategory:s}=e,{showNotification:d}=(0,l.useNotification)(),[u,m]=(0,r.useState)(""),[g,f]=(0,r.useState)(null),[p,h]=(0,r.useState)(""),[y,v]=(0,r.useState)(!1),[x,j]=(0,r.useState)(null),[b,w]=(0,r.useState)(s||null),performDeleteCategory=async e=>{try{let{error:t}=await n.O.from("categories").delete().eq("id",e.id);if(t)throw t;d("カテゴリ「".concat(e.name,"」を削除しました。"),"success")}catch(e){d("カテゴリの削除に失敗しました: ".concat(e.message),"error")}},handleAddCategory=async()=>{if(""===u.trim()){d("カテゴリ名を入力してください。","error");return}try{let{data:e,error:t}=await n.O.from("categories").insert([{name:u.trim()}]).select();if(t)throw t;d("カテゴリ「".concat(u,"」を追加しました。"),"success"),m("")}catch(e){console.error("Failed to add category:",e),d("カテゴリの追加に失敗しました: ".concat(e.message),"error")}},handleEditCategory=async e=>{let t=p.trim();if(""===t){d("カテゴリ名を入力してください。","error");return}try{let{error:o}=await n.O.from("categories").update({name:t}).eq("id",e.id);if(o)throw o;d("カテゴリを更新しました。","success"),f(null)}catch(e){d("カテゴリの更新に失敗しました: ".concat(e.message),"error")}},handleDeleteCategory=e=>{j(e),v(!0)};return(0,a.jsxs)("div",{className:"category-editor-content",onClick:e=>e.stopPropagation(),children:[(0,a.jsx)("h2",{className:"category-editor-title",children:c?"カテゴリ変更":"カテゴリ管理"}),c?(0,a.jsxs)("div",{className:"category-editor-section",children:[(0,a.jsx)("h3",{className:"category-editor-subtitle",children:"カテゴリを選択"}),(0,a.jsxs)("select",{value:b||"",onChange:e=>w(e.target.value||null),className:"category-editor-select",children:[(0,a.jsx)("option",{value:"",children:"未分類"}),o.map(e=>(0,a.jsx)("option",{value:e.name,children:e.name},e.id))]}),(0,a.jsxs)("div",{className:"category-editor-footer",children:[(0,a.jsx)("button",{onClick:()=>{i(b),t()},className:"category-editor-save-button",children:"保存"}),(0,a.jsx)("button",{onClick:t,className:"category-editor-close-button",children:"キャンセル"})]})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"category-editor-section",children:[(0,a.jsx)("h3",{className:"category-editor-subtitle",children:"新しいカテゴリを追加"}),(0,a.jsxs)("div",{className:"category-editor-input-group",children:[(0,a.jsx)("input",{type:"text",placeholder:"新しいカテゴリ名",value:u,onChange:e=>m(e.target.value),className:"category-editor-input"}),(0,a.jsx)("button",{onClick:handleAddCategory,className:"category-editor-add-button",children:"追加"})]})]}),(0,a.jsxs)("div",{className:"category-editor-section",children:[(0,a.jsx)("h3",{className:"category-editor-subtitle",children:"既存カテゴリ"}),o&&0===o.length?(0,a.jsx)("p",{className:"category-editor-no-category-message",children:"まだカテゴリがありません。"}):(0,a.jsx)("ul",{className:"category-editor-category-list",children:o&&o.map(e=>(0,a.jsxs)("li",{className:"category-editor-category-item",children:[(null==g?void 0:g.id)===e.id?(0,a.jsx)("input",{type:"text",value:p,onChange:e=>h(e.target.value),className:"category-editor-edit-input",autoFocus:!0}):(0,a.jsx)("span",{className:"category-editor-category-name",children:e.name}),(0,a.jsx)("div",{className:"category-editor-actions",children:(null==g?void 0:g.id)===e.id?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{onClick:()=>handleEditCategory(e),className:"category-editor-action-button primary",children:(0,a.jsx)(SaveIcon,{})}),(0,a.jsx)("button",{onClick:()=>f(null),className:"category-editor-action-button",children:(0,a.jsx)(CancelIcon,{})})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{onClick:()=>{f(e),h(e.name)},className:"category-editor-action-button",children:(0,a.jsx)(EditIcon,{})}),(0,a.jsx)("button",{onClick:()=>handleDeleteCategory(e),className:"category-editor-action-button error",children:(0,a.jsx)(DeleteIcon,{})})]})})]},e.id))})]}),(0,a.jsx)("div",{className:"category-editor-footer",children:(0,a.jsx)("button",{onClick:t,className:"category-editor-close-button",children:"閉じる"})})]}),x&&(0,a.jsx)(ConfirmModal,{isOpen:y,onClose:()=>v(!1),message:"カテゴリ「".concat(x.name,"」を削除しますか？関連するプリントのカテゴリは解除されます。"),onConfirm:()=>{performDeleteCategory(x),j(null)},onCancel:()=>j(null)})]})}},243:function(e,t,o){o.d(t,{Z:function(){return Modal}});var a=o(7437),r=o(2265);function Modal(e){let{isOpen:t,onClose:o,children:n,title:l}=e,i=(0,r.useRef)(null);return((0,r.useEffect)(()=>{let handleEscape=e=>{"Escape"===e.key&&o()};return t?(document.addEventListener("keydown",handleEscape),document.body.style.overflow="hidden"):(document.removeEventListener("keydown",handleEscape),document.body.style.overflow=""),()=>{document.removeEventListener("keydown",handleEscape),document.body.style.overflow=""}},[t,o]),t)?(0,a.jsx)("div",{className:"modal-overlay",onClick:o,children:(0,a.jsxs)("div",{className:"modal-content",onClick:e=>e.stopPropagation(),ref:i,children:[(0,a.jsxs)("div",{className:"modal-header",children:[l&&(0,a.jsx)("h2",{className:"modal-title",children:l}),(0,a.jsx)("button",{className:"modal-close-button",onClick:o,children:"\xd7"})]}),(0,a.jsx)("div",{className:"modal-body",children:n})]})}):null}},8053:function(e,t,o){o.r(t),o.d(t,{NotificationProvider:function(){return NotificationProvider},useNotification:function(){return useNotification}});var a=o(7437),r=o(2265);let n=(0,r.createContext)(void 0),NotificationProvider=e=>{let{children:t}=e,[o,l]=(0,r.useState)(null),[i,c]=(0,r.useState)("success");return(0,r.useEffect)(()=>{if(o){let e=setTimeout(()=>{l(null)},3e3);return()=>clearTimeout(e)}},[o]),(0,a.jsxs)(n.Provider,{value:{showNotification:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success";l(e),c(t)}},children:[t,o&&(0,a.jsx)("div",{className:"notification-container notification-".concat(i),children:(0,a.jsx)("p",{children:o})})]})},useNotification=()=>{let e=(0,r.useContext)(n);if(void 0===e)throw Error("useNotification must be used within a NotificationProvider");return e}},1037:function(e,t,o){o.d(t,{Q:function(){return usePrints}});var a=o(2265),r=o(1993);function usePrints(e){let[t,o]=(0,a.useState)([]),[n,l]=(0,a.useState)(!0),[i,c]=(0,a.useState)(null),[s,d]=(0,a.useState)([]),u=(0,a.useCallback)(async()=>{try{l(!0),c(null);let e=await (0,r.fH)(null);o(e.reverse());let t=await (0,r.tG)();d(t)}catch(e){c(e instanceof Error?e.message:"Failed to load prints"),console.error("Failed to load prints:",e)}finally{l(!1)}},[]),m=(0,a.useCallback)(async(e,t)=>{try{let a=await (0,r.LR)(e,t);if(a)return o(o=>o.map(o=>o.id===e?{...o,category_name:t}:o)),!0;return!1}catch(e){return console.error("Failed to update category:",e),!1}},[]),g=(0,a.useCallback)(async e=>{try{let t=await (0,r.V6)(e);if(t)return o(t=>t.filter(t=>t.id!==e)),!0;return!1}catch(e){return console.error("Failed to delete print:",e),!1}},[]),f=(0,a.useCallback)(()=>{u()},[u]);return(0,a.useEffect)(()=>{u()},[u]),{prints:t,isLoading:n,error:i,updateCategory:m,removePrint:g,refreshPrints:f,categories:s}}},1993:function(e,t,o){o.d(t,{L2:function(){return uploadMultiplePrints},LR:function(){return updatePrintCategory},V6:function(){return deletePrint},d0:function(){return getPrintById},fH:function(){return getAllPrints},tG:function(){return getAllCategories}});var a=o(2899);let r="prints",n="prints",l="categories";async function getAllCategories(){let{data:e,error:t}=await a.O.from(l).select("*").order("name",{ascending:!0});if(t)throw Error("Failed to fetch categories: ".concat(t.message));return e}async function uploadPrint(e,t,o){if(console.log("[uploadPrint] Starting upload for file: ".concat(e.name,", type: ").concat(e.type,", size: ").concat(e.size)),!e.type.startsWith("image/")&&"application/pdf"!==e.type)throw console.error("[uploadPrint] Invalid file type: ".concat(e.type)),Error("Only image files and PDFs are supported");if(e.size>10485760)throw console.error("[uploadPrint] File size exceeds limit: ".concat(e.size," bytes")),Error("File size must be less than 10MB");let i="".concat(Date.now(),"-").concat(e.name);console.log("[uploadPrint] Generated filePath: ".concat(i)),console.log("[uploadPrint] Attempting to upload to Supabase Storage bucket: ".concat(r));let{data:c,error:s}=await a.O.storage.from(r).upload(i,e,{cacheControl:"3600",upsert:!1});if(s)throw console.error("[uploadPrint] Failed to upload file to storage: ".concat(s.message),s),Error("Failed to upload file: ".concat(s.message));console.log("[uploadPrint] File uploaded to storage successfully:",c),console.log("[uploadPrint] Attempting to get public URL for filePath: ".concat(i));let{data:d}=a.O.storage.from(r).getPublicUrl(i);if(!d||!d.publicUrl)throw console.error("[uploadPrint] Failed to get public URL after upload. publicUrlData:",d),Error("Failed to get public URL after upload.");let u=d.publicUrl;console.log("[uploadPrint] Public URL obtained: ".concat(u));let m=null;if(o){let{data:e,error:t}=await a.O.from(l).select("id").eq("name",o).single();if(t&&"PGRST116"!==t.code)throw console.error("Failed to fetch category: ".concat(t.message)),Error("Failed to process category: ".concat(t.message));if(e)m=e.id;else{let{data:e,error:t}=await a.O.from(l).insert({name:o}).select().single();if(t)throw console.error("Failed to create new category: ".concat(t.message)),Error("Failed to create category: ".concat(t.message));m=e.id}}console.log("[uploadPrint] Attempting to insert print metadata into table: ".concat(n));let{data:g,error:f}=await a.O.from(n).insert({url:u,filename:e.name,uploaded_at:new Date().toISOString(),family_member:t,category_id:m,metadata:{size:e.size,type:e.type}}).select();if(f){console.error("[uploadPrint] Failed to save print metadata to DB: ".concat(f.message),f),console.log("[uploadPrint] Attempting to remove file from storage due to DB insert failure: ".concat(i));let{error:e}=await a.O.storage.from(r).remove([i]);throw e?console.error("[uploadPrint] Failed to remove file from storage after DB insert failure: ".concat(e.message),e):console.log("[uploadPrint] File successfully removed from storage: ".concat(i)),Error("Failed to save print metadata: ".concat(f.message))}return console.log("[uploadPrint] Print metadata inserted successfully:",g),u}async function getAllPrints(e){let t=a.O.from(n).select("*, category:categories(name)").order("uploaded_at",{ascending:!1});e&&(t=t.eq("family_member",e));let{data:o,error:r}=await t;if(r)throw Error("Failed to fetch prints: ".concat(r.message));return o.map(e=>({...e,category_name:e.category?e.category.name:void 0}))}async function getPrintById(e){let{data:t,error:o}=await a.O.from(n).select("*, category:categories(name)").eq("id",e).single();if(o){if("PGRST116"===o.code)return null;throw Error("Failed to fetch print by ID: ".concat(o.message))}return{...t,category_name:t.category?t.category.name:void 0}}async function deletePrint(e){let{data:t,error:o}=await a.O.from(n).select("filename, url").eq("id",e).single();if(o)throw Error("Failed to fetch print for deletion: ".concat(o.message));if(!t)return!1;let l=t.url.split("/"),i=l[l.length-1],{error:c}=await a.O.storage.from(r).remove([i]);c&&console.warn("Failed to delete file from storage: ".concat(c.message));let{error:s}=await a.O.from(n).delete().eq("id",e);if(s)throw Error("Failed to delete print from database: ".concat(s.message));return!0}async function updatePrintCategory(e,t){let o=null;if(t){let{data:e,error:r}=await a.O.from(l).select("id").eq("name",t).single();if(r)throw Error("Failed to find category ID for name ".concat(t,": ").concat(r.message));o=e.id}let{data:r,error:i}=await a.O.from(n).update({category_id:o}).eq("id",e).select();if(i)throw Error("Failed to update print category: ".concat(i.message));return null!==r&&r.length>0}async function uploadMultiplePrints(e,t,o){console.log("[uploadMultiplePrints] Starting batch upload for ".concat(e.length," files."));let a=e.map(e=>uploadPrint(e,t,o)),r=await Promise.allSettled(a),n=[];return r.forEach((t,o)=>{"fulfilled"===t.status?(console.log("[uploadMultiplePrints] File ".concat(e[o].name," uploaded successfully. URL: ").concat(t.value)),n.push(t.value)):console.error("[uploadMultiplePrints] File ".concat(e[o].name," failed to upload. Reason:"),t.reason)}),console.log("[uploadMultiplePrints] Batch upload finished. Successfully uploaded ".concat(n.length," of ").concat(e.length," files.")),n}},2899:function(e,t,o){o.d(t,{O:function(){return l}});var a=o(1492);let r="https://jsheruehpcymrbncbzis.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpzaGVydWVocGN5bXJibmNiemlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwMjg5NjAsImV4cCI6MjA2NjYwNDk2MH0.8Q3jWTND42f-sbXUjXq-lYv-KKO6gosVkk4dmYfFMus";if(!r||!n)throw Error("Missing Supabase URL or Anon Key environment variables");let l=(0,a.eI)(r,n)}}]);