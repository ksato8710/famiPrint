(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[676],{1726:function(e,t,a){Promise.resolve().then(a.bind(a,364))},364:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return UploadPage}});var r=a(7437),l=a(2265),n=a(4033),o=a(1396),i=a.n(o),s=a(1993),c=a(1037);let ArrowBackIcon=()=>(0,r.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",height:"24px",viewBox:"0 0 24 24",width:"24px",fill:"#000000",children:[(0,r.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,r.jsx)("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"})]}),UploadFileIcon=()=>(0,r.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",height:"48px",viewBox:"0 0 24 24",width:"48px",fill:"#6750A4",children:[(0,r.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,r.jsx)("path",{d:"M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"})]});function UploadPage(){let e=(0,n.useRouter)(),{categories:t}=(0,c.Q)(null),[a,o]=(0,l.useState)(!1),[d,u]=(0,l.useState)([]),[p,f]=(0,l.useState)(!1),m=(0,l.useRef)(null),[g,h]=(0,l.useState)(null),[y,v]=(0,l.useState)(""),[w,x]=(0,l.useState)(""),handleFileChange=e=>{e&&u(Array.from(e))},handleUpload=async()=>{if(0===d.length){alert("ファイルを選択してください。");return}if(!g){alert("家族のメンバーを選択してください。");return}let t=w.trim()||y;if(!t){alert("カテゴリを選択または入力してください。");return}o(!0);try{await (0,s.L2)(d,g,t),alert("アップロードが完了しました。"),e.push("/")}catch(e){console.error("Upload failed:",e),alert("アップロードに失敗しました。")}finally{o(!1)}};return(0,r.jsxs)("div",{className:"page-background",children:[(0,r.jsx)("header",{className:"top-app-bar",children:(0,r.jsxs)("div",{className:"app-bar-content",children:[(0,r.jsx)(i(),{href:"/",className:"icon-button",children:(0,r.jsx)(ArrowBackIcon,{})}),(0,r.jsx)("h1",{className:"app-bar-title",children:"新しいプリントを追加"})]})}),(0,r.jsx)("main",{className:"main-content-area",children:(0,r.jsxs)("div",{className:"card-container",children:[(0,r.jsxs)("section",{className:"section-spacing",children:[(0,r.jsx)("h2",{className:"section-title",children:"1. だれのもの？"}),(0,r.jsx)("div",{className:"flex-chips-container",children:["かえで","しおり","あん","ママ","パパ"].map(e=>(0,r.jsx)("button",{onClick:()=>h(e),className:"chip-base ".concat(g===e?"chip-selected":"chip-unselected"),children:e},e))})]}),(0,r.jsxs)("section",{className:"section-spacing",children:[(0,r.jsx)("h2",{className:"section-title",children:"2. どんな種類？"}),(0,r.jsxs)("div",{className:"grid-form-elements",children:[(0,r.jsxs)("select",{value:y,onChange:e=>{v(e.target.value),e.target.value&&x("")},disabled:a||!!w,className:"form-input",children:[(0,r.jsx)("option",{value:"",children:"既存のカテゴリ..."}),t.map(e=>(0,r.jsx)("option",{value:e.name,children:e.name},e.id))]}),(0,r.jsx)("input",{type:"text",placeholder:"または新しいカテゴリ...",value:w,onChange:e=>{x(e.target.value),e.target.value&&v("")},disabled:a,className:"form-input"})]})]}),(0,r.jsxs)("section",{className:"section-spacing-large",children:[(0,r.jsx)("h2",{className:"section-title",children:"3. ファイルを選ぶ"}),(0,r.jsxs)("div",{onClick:()=>{var e;return null===(e=m.current)||void 0===e?void 0:e.click()},onDragOver:e=>{e.preventDefault(),f(!0)},onDragLeave:e=>f(!1),onDrop:e=>{e.preventDefault(),f(!1),handleFileChange(e.dataTransfer.files)},className:"drag-drop-area ".concat(p?"drag-over":""),children:[(0,r.jsx)("input",{ref:m,type:"file",multiple:!0,accept:"image/*,application/pdf",className:"hidden-input",onChange:e=>handleFileChange(e.target.files)}),(0,r.jsxs)("div",{className:"drag-drop-text-container",children:[(0,r.jsx)(UploadFileIcon,{}),(0,r.jsx)("p",{className:"margin-top-small",children:"ファイルをドラッグ＆ドロップ"}),(0,r.jsx)("p",{className:"text-small",children:"またはクリックして選択"})]})]}),d.length>0&&(0,r.jsxs)("div",{className:"file-list-container",children:[(0,r.jsxs)("p",{children:[d.length,"個のファイルを選択中:"]}),(0,r.jsx)("ul",{className:"file-list",children:d.map(e=>(0,r.jsx)("li",{children:e.name},e.name))})]})]}),(0,r.jsx)("div",{className:"text-align-center",children:(0,r.jsx)("button",{onClick:handleUpload,disabled:a||0===d.length||!g||!y&&!w,className:"primary-button",children:a?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"spinner"}),(0,r.jsx)("span",{children:"アップロード中..."})]}):(0,r.jsx)("span",{children:"アップロードする"})})})]})})]})}},1037:function(e,t,a){"use strict";a.d(t,{Q:function(){return usePrints}});var r=a(2265),l=a(1993);function usePrints(e){let[t,a]=(0,r.useState)([]),[n,o]=(0,r.useState)(!0),[i,s]=(0,r.useState)(null),[c,d]=(0,r.useState)([]),u=(0,r.useCallback)(async()=>{try{o(!0),s(null);let e=await (0,l.fH)(null);a(e.reverse());let t=await (0,l.tG)();d(t)}catch(e){s(e instanceof Error?e.message:"Failed to load prints"),console.error("Failed to load prints:",e)}finally{o(!1)}},[]),p=(0,r.useCallback)(async(e,t)=>{try{let r=await (0,l.LR)(e,t);if(r)return a(a=>a.map(a=>a.id===e?{...a,category_name:t}:a)),!0;return!1}catch(e){return console.error("Failed to update category:",e),!1}},[]),f=(0,r.useCallback)(async e=>{try{let t=await (0,l.V6)(e);if(t)return a(t=>t.filter(t=>t.id!==e)),!0;return!1}catch(e){return console.error("Failed to delete print:",e),!1}},[]),m=(0,r.useCallback)(()=>{u()},[u]);return(0,r.useEffect)(()=>{u()},[u]),{prints:t,isLoading:n,error:i,updateCategory:p,removePrint:f,refreshPrints:m,categories:c}}},1993:function(e,t,a){"use strict";a.d(t,{L2:function(){return uploadMultiplePrints},LR:function(){return updatePrintCategory},V6:function(){return deletePrint},d0:function(){return getPrintById},fH:function(){return getAllPrints},tG:function(){return getAllCategories}});var r=a(2899);let l="prints",n="prints",o="categories";async function getAllCategories(){let{data:e,error:t}=await r.O.from(o).select("*").order("name",{ascending:!0});if(t)throw Error("Failed to fetch categories: ".concat(t.message));return e}async function uploadPrint(e,t,a){if(console.log("[uploadPrint] Starting upload for file: ".concat(e.name,", type: ").concat(e.type,", size: ").concat(e.size)),!e.type.startsWith("image/")&&"application/pdf"!==e.type)throw console.error("[uploadPrint] Invalid file type: ".concat(e.type)),Error("Only image files and PDFs are supported");if(e.size>10485760)throw console.error("[uploadPrint] File size exceeds limit: ".concat(e.size," bytes")),Error("File size must be less than 10MB");let i="".concat(Date.now(),"-").concat(e.name);console.log("[uploadPrint] Generated filePath: ".concat(i)),console.log("[uploadPrint] Attempting to upload to Supabase Storage bucket: ".concat(l));let{data:s,error:c}=await r.O.storage.from(l).upload(i,e,{cacheControl:"3600",upsert:!1});if(c)throw console.error("[uploadPrint] Failed to upload file to storage: ".concat(c.message),c),Error("Failed to upload file: ".concat(c.message));console.log("[uploadPrint] File uploaded to storage successfully:",s),console.log("[uploadPrint] Attempting to get public URL for filePath: ".concat(i));let{data:d}=r.O.storage.from(l).getPublicUrl(i);if(!d||!d.publicUrl)throw console.error("[uploadPrint] Failed to get public URL after upload. publicUrlData:",d),Error("Failed to get public URL after upload.");let u=d.publicUrl;console.log("[uploadPrint] Public URL obtained: ".concat(u));let p=null;if(a){let{data:e,error:t}=await r.O.from(o).select("id").eq("name",a).single();if(t&&"PGRST116"!==t.code)throw console.error("Failed to fetch category: ".concat(t.message)),Error("Failed to process category: ".concat(t.message));if(e)p=e.id;else{let{data:e,error:t}=await r.O.from(o).insert({name:a}).select().single();if(t)throw console.error("Failed to create new category: ".concat(t.message)),Error("Failed to create category: ".concat(t.message));p=e.id}}console.log("[uploadPrint] Attempting to insert print metadata into table: ".concat(n));let{data:f,error:m}=await r.O.from(n).insert({url:u,filename:e.name,uploaded_at:new Date().toISOString(),family_member:t,category_id:p,metadata:{size:e.size,type:e.type}}).select();if(m){console.error("[uploadPrint] Failed to save print metadata to DB: ".concat(m.message),m),console.log("[uploadPrint] Attempting to remove file from storage due to DB insert failure: ".concat(i));let{error:e}=await r.O.storage.from(l).remove([i]);throw e?console.error("[uploadPrint] Failed to remove file from storage after DB insert failure: ".concat(e.message),e):console.log("[uploadPrint] File successfully removed from storage: ".concat(i)),Error("Failed to save print metadata: ".concat(m.message))}return console.log("[uploadPrint] Print metadata inserted successfully:",f),u}async function getAllPrints(e){let t=r.O.from(n).select("*, category:categories(name)").order("uploaded_at",{ascending:!1});e&&(t=t.eq("family_member",e));let{data:a,error:l}=await t;if(l)throw Error("Failed to fetch prints: ".concat(l.message));return a.map(e=>({...e,category_name:e.category?e.category.name:void 0}))}async function getPrintById(e){let{data:t,error:a}=await r.O.from(n).select("*, category:categories(name)").eq("id",e).single();if(a){if("PGRST116"===a.code)return null;throw Error("Failed to fetch print by ID: ".concat(a.message))}return{...t,category_name:t.category?t.category.name:void 0}}async function deletePrint(e){let{data:t,error:a}=await r.O.from(n).select("filename, url").eq("id",e).single();if(a)throw Error("Failed to fetch print for deletion: ".concat(a.message));if(!t)return!1;let o=t.url.split("/"),i=o[o.length-1],{error:s}=await r.O.storage.from(l).remove([i]);s&&console.warn("Failed to delete file from storage: ".concat(s.message));let{error:c}=await r.O.from(n).delete().eq("id",e);if(c)throw Error("Failed to delete print from database: ".concat(c.message));return!0}async function updatePrintCategory(e,t){let a=null;if(t){let{data:e,error:l}=await r.O.from(o).select("id").eq("name",t).single();if(l)throw Error("Failed to find category ID for name ".concat(t,": ").concat(l.message));a=e.id}let{data:l,error:i}=await r.O.from(n).update({category_id:a}).eq("id",e).select();if(i)throw Error("Failed to update print category: ".concat(i.message));return null!==l&&l.length>0}async function uploadMultiplePrints(e,t,a){console.log("[uploadMultiplePrints] Starting batch upload for ".concat(e.length," files."));let r=e.map(e=>uploadPrint(e,t,a)),l=await Promise.allSettled(r),n=[];return l.forEach((t,a)=>{"fulfilled"===t.status?(console.log("[uploadMultiplePrints] File ".concat(e[a].name," uploaded successfully. URL: ").concat(t.value)),n.push(t.value)):console.error("[uploadMultiplePrints] File ".concat(e[a].name," failed to upload. Reason:"),t.reason)}),console.log("[uploadMultiplePrints] Batch upload finished. Successfully uploaded ".concat(n.length," of ").concat(e.length," files.")),n}},2899:function(e,t,a){"use strict";a.d(t,{O:function(){return o}});var r=a(1492);let l="https://jsheruehpcymrbncbzis.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpzaGVydWVocGN5bXJibmNiemlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwMjg5NjAsImV4cCI6MjA2NjYwNDk2MH0.8Q3jWTND42f-sbXUjXq-lYv-KKO6gosVkk4dmYfFMus";if(!l||!n)throw Error("Missing Supabase URL or Anon Key environment variables");let o=(0,r.eI)(l,n)}},function(e){e.O(0,[183,396,971,472,744],function(){return e(e.s=1726)}),_N_E=e.O()}]);